### ЁЯУм ржорзЗрж╕рзЗржЬ ржХрж┐ржЙ (Message Queue) ржПрж░ ржерж┐ржУрж░рж┐ тАФ ржмрж╛ржВрж▓рж╛ ржнрж╛рж╖рж╛рзЯ ржмрзНржпрж╛ржЦрзНржпрж╛:

---

### ЁЯФ╢ рж╕ржВржЬрзНржЮрж╛ (Definition):

**Message Queue** рж╣рж▓ ржПржХржЯрж┐ **Inter-Process Communication (IPC)** ржорзЗржХрж╛ржирж┐ржЬржо ржпрж╛рж░ ржорж╛ржзрзНржпржорзЗ ржПржХрж╛ржзрж┐ржХ ржкрзНрж░рж╕рзЗрж╕ ржПржХрзЗ ржЕржкрж░ржХрзЗ ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛рждрзЗ ржмрж╛ ржЧрзНрж░рж╣ржг ржХрж░рждрзЗ ржкрж╛рж░рзЗред ржПржЯрж┐ ржЕрзНржпрж╛рж╕рж┐ржиржХрзНрж░рзЛржирж╛рж╕ ржорзЗрж╕рзЗржЬ ржкрж╛рж╕рж┐ржВрзЯрзЗрж░ рж╕рзБржмрж┐ржзрж╛ ржжрзЗрзЯ, ржЕрж░рзНржерж╛рзО ржкрзНрж░рзЗрж░ржХ (sender) ржПржмржВ ржЧрзНрж░рж╣рзАрждрж╛ (receiver) ржПржХржЗ рж╕ржорзЯ рж╕ржХрзНрж░рж┐рзЯ ржирж╛ ржерж╛ржХрж▓рзЗржУ ржорзЗрж╕рзЗржЬ ржЖржжрж╛ржи-ржкрзНрж░ржжрж╛ржи рж╕ржорзНржнржм рж╣рзЯред

---

### ЁЯФ╢ ржкрзНрж░ржзрж╛ржи ржмрзИрж╢рж┐рж╖рзНржЯрзНржп (Key Features):

1. тЬЕ ржЕрзНржпрж╛рж╕рж┐ржиржХрзНрж░рзЛржирж╛рж╕ ржХржорж┐ржЙржирж┐ржХрзЗрж╢ржи (Asynchronous Communication)
2. тЬЕ FIFO (First In First Out) ржнрж┐рждрзНрждрж┐рждрзЗ ржорзЗрж╕рзЗржЬ ржбрзЗрж▓рж┐ржнрж╛рж░рж┐
3. тЬЕ ржкрзНрж░рждрж┐ржЯрж┐ ржорзЗрж╕рзЗржЬрзЗрж░ рж╕рж╛ржерзЗ ржПржХржЯрж┐ **type (long int)** ржерж╛ржХрзЗ
4. тЬЕ ржорзНржпрж╛рж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛ ржмрж╛ ржкрзЬрж╛рж░ рж╕ржорзЯ **type** ржжрж┐рзЯрзЗ ржлрж┐рж▓рзНржЯрж╛рж░ ржХрж░рж╛ ржпрж╛рзЯ
5. тЬЕ ржорзЗрж╕рзЗржЬ ржХрж┐ржЙ ржЕржкрж╛рж░рзЗрж╢ржиржЧрзБрж▓рзЛ **ржкрж╛рж░рж╕рж┐рж╕рзНржЯрзЗржирзНржЯ**, ржпрждржХрзНрж╖ржг ржирж╛ `msgctl` ржжрж┐рзЯрзЗ ржорзБржЫрзЗ ржлрзЗрж▓рж╛ рж╣рзЯ

---

### ЁЯФ╢ ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЬржирзНржп рж╕рж┐рж╕рзНржЯрзЗржо ржХрж▓ (System Calls):

| ржлрж╛ржВрж╢ржи      | ржЙржжрзНржжрзЗрж╢рзНржп                             | ржЙржжрж╛рж╣рж░ржг                                         |                |
| ---------- | ------------------------------------ | ---------------------------------------------- | -------------- |
| `msgget()` | ржорзЗрж╕рзЗржЬ ржХрж┐ржЙ рждрзИрж░рж┐ ржмрж╛ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕          | \`msgget(key, 0666                             | IPC\_CREAT);\` |
| `msgsnd()` | ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛ                         | `msgsnd(msqid, &msg, sizeof(msg.text), 0);`    |                |
| `msgrcv()` | ржорзЗрж╕рзЗржЬ ржЧрзНрж░рж╣ржг                          | `msgrcv(msqid, &msg, sizeof(msg.text), 1, 0);` |                |
| `msgctl()` | ржорзЗрж╕рзЗржЬ ржХрж┐ржЙ ржХржирзНржЯрзНрж░рзЛрж▓ (ржпрзЗржоржи delete ржХрж░рж╛) | `msgctl(msqid, IPC_RMID, NULL);`               |                |

---

### ЁЯФ╢ рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░:

```c
struct msgbuf {
    long mtype;      // ржорзЗрж╕рзЗржЬрзЗрж░ ржЯрж╛ржЗржк (1, 2, 3 ржЗрждрзНржпрж╛ржжрж┐)
    char mtext[100]; // ржорзЗрж╕рзЗржЬрзЗрж░ ржмрж┐рж╖рзЯржмрж╕рзНрждрзБ
};
```

---

### ЁЯФ╢ ржЙржжрж╛рж╣рж░ржг ржЪрж┐рждрзНрж░ (рж╕рж╛ржзрж╛рж░ржгржнрж╛ржмрзЗ):

```
+------------+      msgsnd()      +------------+
| Sender App | -----------------> | Message Queue |
+------------+                   +------------+
                                     |
                                     |  msgrcv()
                                     v
                              +-------------+
                              | Receiver App|
                              +-------------+
```

---

### ЁЯФ╢ рж╕рзБржмрж┐ржзрж╛ (Advantages):

* ржкрзНрж░рж╕рзЗрж╕ржЧрзБрж▓рзЛрж░ ржоржзрзНржпрзЗ loose coupling ржерж╛ржХрзЗ
* ржЕрзНржпрж╛рж╕рж┐ржиржХрзНрж░рзЛржирж╛рж╕ ржкржжрзНржзрждрж┐рж░ ржЬржирзНржп efficiency ржмрж╛рзЬрзЗ
* рж╕рж┐рж╕рзНржЯрзЗржорзЗрж░ ржоржзрзНржпрзЗ safe ржПржмржВ synchronized ржХржорж┐ржЙржирж┐ржХрзЗрж╢ржи ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗ

---

### ЁЯФ╢ ржЕрж╕рзБржмрж┐ржзрж╛ (Disadvantages):

* ржмрзНржпржмрж╕рзНржерж╛ржкржирж╛ ржХрж┐ржЫрзБржЯрж╛ ржЬржЯрж┐рж▓
* рж╕рж╛ржЗржЬ рж▓рж┐ржорж┐ржЯрзЗрж╢ржи ржерж╛ржХрзЗ (ржорзЗрж╕рзЗржЬ ржХрж┐ржЙ, ржорзЗрж╕рзЗржЬ per ржХрж┐ржЙ)
* ржЕржирзЗржХ рж╕ржорзЯ proper synchronization ржХрж░рждрзЗ рж╣рзЯ

---


```c
#include <stdlib.h>     // рж╕рзНржЯрзНржпрж╛ржирзНржбрж╛рж░рзНржб рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржлрж╛ржВрж╢ржирзЗрж░ ржЬржирзНржп
#include <unistd.h>     // ржлрж░рзНржХ ржУ ржЕржирзНржпрж╛ржирзНржп рж╕рж┐рж╕рзНржЯрзЗржо ржХрж▓рзЗрж░ ржЬржирзНржп
#include <sys/wait.h>   // wait() ржлрж╛ржВрж╢ржирзЗрж░ ржЬржирзНржп
#include <sys/msg.h>    // ржорзНржпрж╛рж╕рзЗржЬ ржХрж┐ржЙ рж╕ржорзНржкрж░рзНржХрж┐ржд ржлрж╛ржВрж╢ржирзЗрж░ ржЬржирзНржп
#include <stdio.h>      // ржЗржиржкрзБржЯ ржЖржЙржЯржкрзБржЯрзЗрж░ ржЬржирзНржп (printf, perror)
#include <string.h>     // рж╕рзНржЯрзНрж░рж┐ржВ ржХржкрж┐ ржХрж░рж╛рж░ ржЬржирзНржп (strcpy)

// ржорзНржпрж╛рж╕рзЗржЬ ржХрж┐ржЙ ржПрж░ ржЬржирзНржп рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ ржбрж┐ржлрж╛ржЗржи
struct msg_queue {
    long type;         // ржорзНржпрж╛рж╕рзЗржЬ ржЯрж╛ржЗржк (ржЕржмрж╢рзНржпржЗ long ржПржмржВ > 0 рж╣рждрзЗ рж╣ржмрзЗ)
    char text[80];     // ржорзНржпрж╛рж╕рзЗржЬ ржЯрзЗржХрзНрж╕ржЯ рж░рж╛ржЦрж╛рж░ ржЬржирзНржп
};

int main() {
    struct msg_queue msg;          // msg_queue ржЯрж╛ржЗржкрзЗрж░ ржПржХржЯрж┐ ржнрзЗрж░рж┐рзЯрзЗржмрж▓ рждрзИрж░рж┐
    key_t key = 1234;              // ржорзНржпрж╛рж╕рзЗржЬ ржХрж┐ржЙ ржЪрж┐рж╣рзНржирж┐ржд ржХрж░рж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржХрзА

    // ржорзНржпрж╛рж╕рзЗржЬ ржХрж┐ржЙ рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ (ржЕржержмрж╛ ржЖржЧрзЗрж░ржЯрж╛ ржкрж╛ржУрзЯрж╛ ржЧрзЗрж▓рзЗ рж╕рзЗржЯрж╛ рж░рж┐ржЯрж╛рж░рзНржи ржХрж░ржмрзЗ)
    int msqid = msgget(key, 0666 | IPC_CREAT);
    if (msqid == -1) {             // ржпржжрж┐ ржорзНржпрж╛рж╕рзЗржЬ ржХрж┐ржЙ рждрзИрж░рж┐ ржмрзНржпрж░рзНрже рж╣рзЯ
        perror("msgget");         // ржПрж░рж░ ржорзЗрж╕рзЗржЬ ржкрзНрж░рж┐ржирзНржЯ ржХрж░рзЗ
        exit(EXIT_FAILURE);       // ржкрзНрж░рзЛржЧрзНрж░рж╛ржо ржмржирзНржз ржХрж░рзЗ ржжрзЗрзЯ
    }

    pid_t pid = fork();           // ржПржХржЯрж┐ ржирждрзБржи ржкрзНрж░рж╕рзЗрж╕ рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ

    if (pid == 0) {
        // ржЪрж╛ржЗрж▓рзНржб ржкрзНрж░рж╕рзЗрж╕
        printf("Child\n");         // ржЪрж╛ржЗрж▓рзНржб ржкрзНрж░рж╕рзЗрж╕ ржЪрж▓ржЫрзЗ

        msg.type = 1;              // ржорзНржпрж╛рж╕рзЗржЬ ржЯрж╛ржЗржк рзз рж╕рзЗржЯ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ (ржЕржмрж╢рзНржпржЗ > 0)
        strcpy(msg.text, "Hello, Parent\n");   // ржорзНржпрж╛рж╕рзЗржЬ ржХржирзНржЯрзЗржирзНржЯ ржХржкрж┐ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ

        // ржорзНржпрж╛рж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛ рж╣ржЪрзНржЫрзЗ ржХрж┐ржЙ-рждрзЗ
        if (msgsnd(msqid, &msg, sizeof(msg.text), 0) == -1) {
            perror("msgsnd");     // ржорзНржпрж╛рж╕рзЗржЬ ржкрж╛ржарж╛рждрзЗ ржмрзНржпрж░рзНрже рж╣рж▓рзЗ ржПрж░рж░ ржжрзЗржЦрж╛ржмрзЗ
            exit(EXIT_FAILURE);   // ржкрзНрж░рзЛржЧрзНрж░рж╛ржо ржмржирзНржз
        }
    } else {
        // ржкрзНржпрж╛рж░рзЗржирзНржЯ ржкрзНрж░рж╕рзЗрж╕
        printf("Parent\n");       // ржкрзНржпрж╛рж░рзЗржирзНржЯ ржкрзНрж░рж╕рзЗрж╕ ржЪрж▓ржЫрзЗ

        int status;
        wait(&status);            // ржЪрж╛ржЗрж▓рзНржб ржкрзНрж░рж╕рзЗрж╕ рж╢рзЗрж╖ рж╣ржУрзЯрж╛ ржкрж░рзНржпржирзНржд ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ

        // ржорзНржпрж╛рж╕рзЗржЬ ржХрж┐ржЙ ржерзЗржХрзЗ ржорзНржпрж╛рж╕рзЗржЬ рж░рж┐рж╕рж┐ржн ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ
        if (msgrcv(msqid, &msg, sizeof(msg.text), 1, 0) == -1) {
            perror("msgrcv");     // рж░рж┐рж╕рж┐ржн ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣рж▓рзЗ ржПрж░рж░ ржжрзЗржЦрж╛ржмрзЗ
            exit(EXIT_FAILURE);   // ржкрзНрж░рзЛржЧрзНрж░рж╛ржо ржмржирзНржз
        }

        printf("Received message: %s", msg.text);  // рж░рж┐рж╕рж┐ржн ржХрж░рж╛ ржорзНржпрж╛рж╕рзЗржЬ ржкрзНрж░рж┐ржирзНржЯ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ

        // ржорзНржпрж╛рж╕рзЗржЬ ржХрж┐ржЙ ржбрж┐рж▓рж┐ржЯ ржХрж░рзЗ ржлрзЗрж▓рж╛ рж╣ржЪрзНржЫрзЗ
        msgctl(msqid, IPC_RMID, NULL);
    }

    return 0;   // ржкрзНрж░рзЛржЧрзНрж░рж╛ржо рж╕ржлрж▓ржнрж╛ржмрзЗ рж╢рзЗрж╖
}
```

